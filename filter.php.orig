<?php // $Id: filter.php,v 1.38.2.10 2009/05/07 08:55:50 nicolasconnault Exp $
//////////////////////////////////////////////////////////////
//  MP4 plugin filtering
//
//  This filter will replace any links to a mp4 or m4v file with
//  a media plugin that plays that media inline
//
//  To activate this filter, add a line like this to your
//  list of filters in your Filter configuration:
//
//  filter/mp4plugin/filter.php
//
//////////////////////////////////////////////////////////////

/// This is the filtering function itself.  It accepts the
/// courseid and the text to be filtered (in HTML form).

require_once($CFG->libdir.'/filelib.php');


function mp4filter_filter($courseid, $text) {
    global $CFG;

    if (!is_string($text)) {
        // non string data can not be filtered anyway
        return $text;
    }
    $newtext = $text; // fullclone is slow and not needed here

//Filter for M4V
        $search = '/<a.*?href="([^<]+\.m4v)(\?d=([\d]{1,4}%?)x([\d]{1,4}%?))?"[^>]*>.*?<\/a>/is';
        $newtext = preg_replace_callback($search, 'mediaplugin_filter_mp4_callback', $newtext);

//Filter for MP4
        $search = '/<a.*?href="([^<]+\.mp4)(\?d=([\d]{1,4}%?)x([\d]{1,4}%?))?"[^>]*>.*?<\/a>/is';
        $newtext = preg_replace_callback($search, 'mediaplugin_filter_mp4_callback', $newtext);
	
    return $newtext;
}

///===========================
/// callback filter functions

function mediaplugin_filter_mp4_callback($link) {
    global $CFG;

    static $count = 0;
    $count++;
    $id = 'filter_mp4_'.time().$count; //we need something unique because it might be stored in text cache

    $width  = empty($link[3]) ? '480' : $link[3];
    $height = empty($link[4]) ? '360' : $link[4];
    $url = addslashes_js($link[1]);

    return $link[0].
'<span class="mediaplugin mediaplugin_mp4" id="'.$id.'">MP4 Video</span>
<script type="text/javascript" src="'.$CFG->wwwroot.'/filter/mp4filter/swfobject.js"></script> 
<script type="text/javascript">
//<![CDATA[
var s1 = new SWFObject("'.$CFG->wwwroot.'/filter/mp4filter/player.swf","player","'.$width.'","'.$height.'","9");
s1.addParam("allowfullscreen","true");
s1.addParam("allowscriptaccess","always");
s1.addParam("flashvars","file='.$url.'");
s1.write("'.$id.'");
//]]>
</script>';
}

?>